{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="no">
<head>
<body>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 d-none d-md-block sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('robot_fleet.robot_fleet') }}"><i class="fas fa-ship"></i> Flåteoversikt</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('missions.missions') }}"><i class="fas fa-briefcase"></i> Oppdrag</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('history.history') }}"><i class="fas fa-history"></i> Historikk</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-bell"></i> Notifikasjoner</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-cog"></i> Innstillinger</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-sign-out-alt"></i> Logg Ut</a>
                    </li>                                     
                </ul>
            </nav>
            <main role="main" class="col-md-10 ml-sm-auto col-lg-10 px-4">
                <br><br>
                <h1>God morgen, Alise</h1>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                Pågående Oppdrag
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">3 aktive oppdrag</h5>
                                <div class="oppdrag-liste">
                                    <div class="oppdrag">
                                        <div class="oppdrag-kolonne"><i class="fas fa-robot"></i> Robot 1</div>
                                        <div class="oppdrag-kolonne">Mezzanine Deck</div>
                                        <div class="oppdrag-kolonne">Ferdig om 30 minutter</div>
                                    </div>
                                    <div class="oppdrag">
                                        <div class="oppdrag-kolonne"><i class="fas fa-robot"></i> Robot 2</div>
                                        <div class="oppdrag-kolonne">Mezzanine Deck First valve</div>
                                        <div class="oppdrag-kolonne">Ferdig om 1 time</div>
                                    </div>
                                    <div class="oppdrag">
                                        <div class="oppdrag-kolonne"><i class="fas fa-robot"></i> Robot 3</div>
                                        <div class="oppdrag-kolonne">Mezzanine Deck Second valve</div>
                                        <div class="oppdrag-kolonne">Ferdig om 2 timer</div>
                                    </div>
                                </div>
                                <a href="#" class="btn btn-secondary">Se alle oppdrag</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                            Anleggsoversikt
                            </div>
                            <div class="card-body">
                                </div>
                                <div id="robot-positions-container"></div>
                                <div id="map" style="position: relative; width: 842px; height: 851px; background-image: url('/static/Facility_map.png');"></div>

                            </div>
                        </div>
                    </div>                
                </div>
            </main>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

            socket.on('update_robot_heartbeat', function(msg) {
                const data = JSON.parse(msg.data);
                const robotName = data.robot_name;
                const heartbeat = data.timestamp;
                updateRobotInfo(robotName, heartbeat);
            });

            socket.on('update_pose', function(msg) {
                const data = JSON.parse(msg.data);
                
                if(data.pose && data.pose.position) {
                    const position = data.pose.position;
                    updateRobotPosition(data.isar_id, data.robot_name, position.x, position.y, position.z);
                } else {
                    console.error('Pose eller position er undefined', data);
                }
            });




            function updateRobotPosition(isarId, robotName, x, y, z) {
                var map = document.getElementById('map');

                var robotMapElement = document.getElementById(`robot-map-${isarId}`);
                var robotNameElement = document.getElementById(`robot-name-${isarId}`);

                if (!robotMapElement) {
                    robotMapElement = document.createElement('div');
                    robotMapElement.id = `robot-map-${isarId}`;
                    robotMapElement.style.position = 'absolute';
                    robotMapElement.style.width = '10px';
                    robotMapElement.style.height = '10px';
                    robotMapElement.style.borderRadius = '50%';
                    robotMapElement.style.backgroundColor = 'red';
                    map.appendChild(robotMapElement);

                    robotNameElement = document.createElement('div');
                    robotNameElement.id = `robot-name-${isarId}`;
                    robotNameElement.style.position = 'absolute';
                    robotNameElement.style.whiteSpace = 'nowrap';
                    robotNameElement.style.color = 'black';
                    robotNameElement.style.fontSize = '12px';
                    robotNameElement.style.backgroundColor = 'white';
                    robotNameElement.style.padding = '2px 5px';
                    robotNameElement.style.borderRadius = '4px';
                    map.appendChild(robotNameElement);
                }

                var xPos = (x / 10) * 514;
                var yPos = (y / 10) * 472;

                robotMapElement.style.left = `${xPos}px`;
                robotMapElement.style.top = `${yPos}px`;

                robotNameElement.innerHTML = robotName;
                robotNameElement.style.left = `${xPos - 5}px`;
                robotNameElement.style.top = `${yPos + 15}px`;
            }

            function updateRobotInfo(robotName, heartbeat, position) {
                var infoElement = document.getElementById('robot-info');
                infoElement.innerHTML = 'Robot: ' + robotName + '<br>' + 'Hjerteslag: ' + heartbeat;
            }

        });
    </script>
</body>
</html>
{% endblock %}
